# risc-v

# trap

中断发生时候会关中断， [m/r]ret 会恢复中断

# instructions

1. (pseudo) ret
   jalr zero, 0(ra)
2. (pseudo) mv rd, rs
   addi rd, rs, 0

# rcore

## task

任务切换的瞬间，也就是执行 `__switch` 之后，是在 S 模式完成的，也就是在异常处理函数内部，具体来说是在 `run_next_task` 函数里，这时候还没返回用户态就已经切换任务了。

任务切换的实际不直接是用户态程序的状态，而是用户态陷入内核态后的状态，这个状态下的sp上保存了陷入的用户程序状态，所以能在返回用户态的时候恢复到其他用户程序。

也就是任务切换有以下阶段：
1. `__alltraps` 保存用户状态， 转变到当前内核态
2. `__switch` 切换当前内核态到另一个内核态
3. `__restore` 在当前内核态下恢复当前内核态中存储的被陷入的用户程序状态

因此
